{
  "prdFilename": "cart-event-normalizer-package",
  "tasks": [
    {
      "id": "1",
      "title": "Create package structure and configuration",
      "description": "Set up @rr/cart-event-normalizer package with TypeScript, ESM, and monorepo integration",
      "status": "done",
      "priority": "high",
      "dependencies": [],
      "details": "Create packages/cart-normalizer/ with package.json, tsconfig.json, vitest.config.ts. Add to pnpm workspace. Configure exports for src/index.ts.",
      "testStrategy": "Verify package builds and exports are accessible from other packages",
      "subtasks": [],
      "userStoryId": "US001",
      "createdAt": "2025-12-08T23:32:03.043Z",
      "updatedAt": "2025-12-08T23:50:56.509Z",
      "complexity": 2,
      "recommendedSubtasks": 2,
      "completedAt": "2025-12-08T23:50:56.509Z"
    },
    {
      "id": "2",
      "title": "Define Zod schemas for input and output types",
      "description": "Create RawCartEventSchema for input validation and CartProductSchema for output typing",
      "status": "done",
      "priority": "high",
      "dependencies": ["1"],
      "details": "Define RawCartEventSchema matching the cart event JSON structure. Define CartProductSchema with title, url, imageUrl, storeId, price, productIds. Export inferred types. Include optional fields appropriately.",
      "testStrategy": "Unit tests validating schema accepts valid events and rejects malformed data",
      "subtasks": [],
      "userStoryId": "US005",
      "createdAt": "2025-12-08T23:32:03.109Z",
      "updatedAt": "2025-12-08T23:50:56.591Z",
      "complexity": 4,
      "recommendedSubtasks": 3,
      "completedAt": "2025-12-08T23:50:56.591Z"
    },
    {
      "id": "3",
      "title": "Implement normalizeCartEvent main function",
      "description": "Create the core normalization function that transforms RawCartEvent to CartProduct[]",
      "status": "done",
      "priority": "high",
      "dependencies": ["2"],
      "details": "Extract product_list from event. Map each product to CartProduct with field renaming (name->title, image_url->imageUrl, item_price->price). Filter products missing url and title. Return frozen array.",
      "testStrategy": "Test with sample cart events, empty carts, missing fields, various product counts",
      "subtasks": [],
      "userStoryId": "US001",
      "createdAt": "2025-12-08T23:32:03.172Z",
      "updatedAt": "2025-12-08T23:50:56.679Z",
      "complexity": 3,
      "recommendedSubtasks": 2,
      "completedAt": "2025-12-08T23:50:56.679Z"
    },
    {
      "id": "4",
      "title": "Integrate @rr/product-id-extractor for URL parsing",
      "description": "Add product ID extraction from product URLs using the existing extractor package",
      "status": "done",
      "priority": "high",
      "dependencies": ["3"],
      "details": "Import extractIdsFromUrlComponents from @rr/product-id-extractor. Parse each product URL with @rr/url-parser. Pass store_id from parent event for store-specific patterns. Add extracted IDs to productIds field.",
      "testStrategy": "Test with URLs from various merchants, verify IDs match expected patterns",
      "subtasks": [],
      "userStoryId": "US002",
      "createdAt": "2025-12-08T23:32:03.234Z",
      "updatedAt": "2025-12-08T23:50:56.757Z",
      "complexity": 4,
      "recommendedSubtasks": 3,
      "completedAt": "2025-12-08T23:50:56.757Z"
    },
    {
      "id": "5",
      "title": "Add store context propagation",
      "description": "Include store_id from parent cart event on each normalized product",
      "status": "done",
      "priority": "high",
      "dependencies": ["3"],
      "details": "Copy store_id from RawCartEvent to storeId on each CartProduct. Handle missing store_id (use undefined). Ensure storeId is number type matching source.",
      "testStrategy": "Verify storeId present on all products, test missing store_id handling",
      "subtasks": [],
      "userStoryId": "US003",
      "createdAt": "2025-12-08T23:32:03.294Z",
      "updatedAt": "2025-12-08T23:50:56.834Z",
      "complexity": 3,
      "recommendedSubtasks": 2,
      "completedAt": "2025-12-08T23:50:56.834Z"
    },
    {
      "id": "6",
      "title": "Implement immutable output with Object.freeze",
      "description": "Freeze all output arrays and objects to prevent mutation",
      "status": "done",
      "priority": "medium",
      "dependencies": ["3"],
      "details": "Object.freeze() the output CartProduct[] array. Freeze each CartProduct object. Freeze nested productIds arrays. Use readonly TypeScript modifiers on types.",
      "testStrategy": "Verify mutations throw in strict mode, TypeScript prevents assignment",
      "subtasks": [],
      "userStoryId": "US006",
      "createdAt": "2025-12-08T23:32:03.353Z",
      "updatedAt": "2025-12-08T23:50:56.909Z",
      "complexity": 2,
      "recommendedSubtasks": 2,
      "completedAt": "2025-12-08T23:50:56.909Z"
    },
    {
      "id": "7",
      "title": "Add comprehensive test suite with fixtures",
      "description": "Create test fixtures from real cart events and comprehensive unit tests",
      "status": "done",
      "priority": "high",
      "dependencies": ["3", "4", "8"],
      "details": "Create __fixtures__/ with sample cart events from various merchants. Test normalizeCartEvent with valid events, edge cases, errors. Test ID extraction integration. Target 100% coverage.",
      "testStrategy": "Vitest with coverage reporting, concurrent test execution",
      "subtasks": [],
      "userStoryId": "US001",
      "createdAt": "2025-12-08T23:32:03.407Z",
      "updatedAt": "2025-12-08T23:50:56.987Z",
      "complexity": 3,
      "recommendedSubtasks": 2,
      "completedAt": "2025-12-08T23:50:56.987Z"
    },
    {
      "id": "8",
      "title": "Create test fixtures from real cart events",
      "description": "Save the sample cart event JSON data as test fixtures covering all edge cases",
      "status": "done",
      "priority": "high",
      "dependencies": ["1"],
      "details": "Create fixtures for: MLB Shop (no product URL), Barnes & Noble (multiple products with URLs), Ancestry (products with no name/URL - just price), Anthropologie (URL with query params), Ulta (empty product_list), StockX (no product URL), Macy's (string store_id), Lowes (Android app), Best Buy (price=0), Reebok (shop.app checkout URL), DSW (no product URL), Bloomingdale's (complex URL params)",
      "testStrategy": "Each fixture should have corresponding expected output for validation",
      "subtasks": [],
      "userStoryId": "US007",
      "createdAt": "2025-12-08T23:39:16.237Z",
      "updatedAt": "2025-12-08T23:50:57.067Z",
      "completedAt": "2025-12-08T23:50:57.067Z"
    },
    {
      "id": "9",
      "title": "Handle string and number store_id types",
      "description": "Normalize store_id to number regardless of input type (string from App, number from Toolbar)",
      "status": "done",
      "priority": "high",
      "dependencies": ["2"],
      "details": "App events send store_id as string ('8333'), Toolbar events send as number (8333). Parse both to number. Handle edge cases: undefined, null, empty string, non-numeric strings.",
      "testStrategy": "Test with string, number, undefined, null, and invalid store_id values",
      "subtasks": [],
      "userStoryId": "US008",
      "createdAt": "2025-12-08T23:39:16.296Z",
      "updatedAt": "2025-12-08T23:50:57.175Z",
      "completedAt": "2025-12-08T23:50:57.175Z"
    },
    {
      "id": "10",
      "title": "Add quantity and lineTotal to output schema",
      "description": "Include quantity and line_total fields in CartProduct output for cart analytics",
      "status": "done",
      "priority": "medium",
      "dependencies": ["2"],
      "details": "Map quantity -> quantity, line_total -> lineTotal. Both optional. Handle quantity=0 (valid for wishlists). Handle missing fields gracefully.",
      "testStrategy": "Verify quantity and lineTotal present when available, undefined when missing",
      "subtasks": [],
      "userStoryId": "US009",
      "createdAt": "2025-12-08T23:39:16.360Z",
      "updatedAt": "2025-12-08T23:50:57.273Z",
      "completedAt": "2025-12-08T23:50:57.273Z"
    },
    {
      "id": "11",
      "title": "Handle products with missing URL gracefully",
      "description": "Include products in output even when URL is missing, with empty productIds array",
      "status": "done",
      "priority": "high",
      "dependencies": ["3"],
      "details": "Many products lack URLs (MLB Shop, StockX, DSW, Ancestry). Include these with productIds: []. Only filter products that have no useful data at all (empty objects). Minimal valid product: has at least name OR price.",
      "testStrategy": "Test with products missing URL, missing name, missing both, having only price",
      "subtasks": [],
      "userStoryId": "US007",
      "createdAt": "2025-12-08T23:39:16.421Z",
      "updatedAt": "2025-12-08T23:50:57.363Z",
      "completedAt": "2025-12-08T23:50:57.363Z"
    },
    {
      "id": "12",
      "title": "Update product validation logic",
      "description": "Change validation rules: products must have URL, OR if no URL then must have both title AND price",
      "status": "done",
      "priority": "high",
      "dependencies": [],
      "details": "Current logic: valid if has name OR price. New logic: valid if has URL, OR (has title AND has price). This ensures products without URLs still have enough data to be useful (both name for identification and price for analytics).",
      "testStrategy": "Update tests to verify: products with URL are valid regardless of other fields, products without URL require both title AND price, products with only title (no URL, no price) are filtered, products with only price (no URL, no title) are filtered",
      "subtasks": [],
      "userStoryId": "US007",
      "createdAt": "2025-12-08T23:53:04.709Z",
      "updatedAt": "2025-12-08T23:54:32.619Z",
      "completedAt": "2025-12-08T23:54:32.619Z"
    },
    {
      "id": "13",
      "title": "Create normalize-cart-events function directory structure",
      "description": "Set up the function folder following existing patterns with handler.ts, contracts.ts, logger.ts, event.json, and __tests__/",
      "status": "done",
      "priority": "high",
      "dependencies": [],
      "details": "Create apps/product-service/src/functions/normalize-cart-events/ directory with all standard files. Follow the same structure as create-url-analysis function.",
      "testStrategy": "Verify directory structure matches existing function folders",
      "subtasks": [],
      "userStoryId": "US010",
      "createdAt": "2025-12-09T00:08:00.217Z",
      "updatedAt": "2025-12-09T04:16:22.869Z",
      "completedAt": "2025-12-09T04:16:22.869Z"
    },
    {
      "id": "14",
      "title": "Define API contracts with Zod schemas",
      "description": "Create contracts.ts with request/response schemas using Zod and OpenAPI metadata",
      "status": "done",
      "priority": "high",
      "dependencies": ["13"],
      "details": "Define NormalizeCartEventsRequestSchema (array of RawCartEvent, 1-100 items), NormalizeCartEventsResponseSchema (results array with per-event success/failure, summary stats), and ErrorResponseSchema. Use extendZodWithOpenApi for documentation.",
      "testStrategy": "Unit tests for schema validation of valid and invalid inputs",
      "subtasks": [],
      "userStoryId": "US010",
      "createdAt": "2025-12-09T00:08:00.312Z",
      "updatedAt": "2025-12-09T04:16:22.896Z",
      "completedAt": "2025-12-09T04:16:22.896Z"
    },
    {
      "id": "15",
      "title": "Implement normalize-cart-events handler",
      "description": "Create Lambda handler that normalizes cart events using @rr/cart-event-normalizer",
      "status": "done",
      "priority": "high",
      "dependencies": ["14"],
      "details": "Handler accepts POST with array of cart events, processes in parallel with Promise.all(), returns per-event results with success/failure flags. Use Middy middleware chain (httpJsonBodyParser, httpErrorHandler). Handle validation errors with 400 status, unexpected errors with 500.",
      "testStrategy": "Integration tests covering success, validation errors, partial failures, empty arrays",
      "subtasks": [],
      "userStoryId": "US010",
      "createdAt": "2025-12-09T00:08:00.406Z",
      "updatedAt": "2025-12-09T04:16:22.926Z",
      "completedAt": "2025-12-09T04:16:22.926Z"
    },
    {
      "id": "16",
      "title": "Add function to esbuild and SAM template",
      "description": "Configure build and deployment for the new endpoint",
      "status": "done",
      "priority": "high",
      "dependencies": ["15"],
      "details": "Add entry point to esbuild.config.mjs: 'normalize-cart-events': 'src/functions/normalize-cart-events/handler.ts'. Add AWS::Serverless::Function to template.yaml with POST /cart-events/normalize route.",
      "testStrategy": "Verify build succeeds and function deploys correctly",
      "subtasks": [],
      "userStoryId": "US010",
      "createdAt": "2025-12-09T00:08:00.495Z",
      "updatedAt": "2025-12-09T04:16:22.954Z",
      "completedAt": "2025-12-09T04:16:22.954Z"
    },
    {
      "id": "17",
      "title": "Add endpoint to local development server",
      "description": "Register the new route in local-server.mjs for local testing",
      "status": "done",
      "priority": "medium",
      "dependencies": ["16"],
      "details": "Add route entry to ROUTES array in local-server.mjs following existing pattern. Test endpoint works with npm run offline.",
      "testStrategy": "Manual testing with curl/Postman against local server",
      "subtasks": [],
      "userStoryId": "US010",
      "createdAt": "2025-12-09T00:08:00.587Z",
      "updatedAt": "2025-12-09T04:16:22.997Z",
      "completedAt": "2025-12-09T04:16:22.997Z"
    },
    {
      "id": "18",
      "title": "Create comprehensive test suite for handler",
      "description": "Write thorough tests following existing patterns in __tests__/handler.test.ts",
      "status": "done",
      "priority": "high",
      "dependencies": ["15"],
      "details": "Test cases: successful normalization, batch processing, validation errors (empty array, invalid events, exceeds max), partial failures, response structure validation, logging verification, edge cases (empty product lists, missing fields).",
      "testStrategy": "Achieve >90% code coverage, test all error paths",
      "subtasks": [],
      "userStoryId": "US010",
      "createdAt": "2025-12-09T00:08:00.678Z",
      "updatedAt": "2025-12-09T04:16:23.038Z",
      "completedAt": "2025-12-09T04:16:23.038Z"
    },
    {
      "id": "19",
      "title": "Generate and verify OpenAPI documentation",
      "description": "Ensure OpenAPI docs are auto-generated from Zod schemas",
      "status": "done",
      "priority": "medium",
      "dependencies": ["16"],
      "details": "Run pnpm run docs:generate to regenerate OpenAPI spec. Verify new endpoint appears in docs/openapi.json and docs/index.html. Check schema definitions are complete.",
      "testStrategy": "Visual inspection of generated docs, schema completeness check",
      "subtasks": [],
      "userStoryId": "US010",
      "createdAt": "2025-12-09T00:08:00.769Z",
      "updatedAt": "2025-12-09T04:17:46.066Z",
      "completedAt": "2025-12-09T04:17:46.066Z"
    }
  ],
  "metadata": {
    "version": "1.0",
    "created": "2025-12-08T23:32:03.043Z",
    "lastUpdated": "2025-12-09T04:17:46.066Z",
    "totalTasks": 19,
    "completedTasks": 19,
    "blockedTasks": 0
  }
}
