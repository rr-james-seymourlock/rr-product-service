{
  "prdFilename": "product-image-fetcher-package",
  "tasks": [
    {
      "id": "1",
      "title": "Create @rr/product-image-fetcher package structure",
      "description": "Initialize the new package with standard monorepo configuration including package.json, tsconfig.json, vitest.config.ts, and src directory structure",
      "status": "done",
      "priority": "high",
      "dependencies": [],
      "details": "Use existing packages as template (e.g., @rr/product-event-normalizer). Include: src/index.ts exports, src/types.ts for Zod schemas, src/config.ts for constants, src/__tests__/ directory. Add to pnpm-workspace.yaml if needed.",
      "testStrategy": "Package builds successfully with pnpm --filter @rr/product-image-fetcher build",
      "subtasks": [],
      "userStoryId": "US001",
      "createdAt": "2025-12-10T15:55:43.643Z",
      "updatedAt": "2025-12-10T16:42:33.570Z",
      "complexity": 4,
      "recommendedSubtasks": 3,
      "completedAt": "2025-12-10T16:42:33.570Z"
    },
    {
      "id": "2",
      "title": "Define Zod schemas for image fetch request/response",
      "description": "Create TypeScript types and Zod schemas for ImageFetchRequest, ImageFetchResponse, ImageFetchError, and configuration options",
      "status": "done",
      "priority": "high",
      "dependencies": ["1"],
      "details": "ImageFetchRequest: { storeId: string, productUrl: string, imageUrl: string }. ImageFetchResponse: { success: true, storagePath: string, contentType: string, sizeBytes: number } | { success: false, error: ImageFetchError }. ImageFetchError: { code: string, message: string, isPermanent: boolean, statusCode?: number, retryAfter?: number, domain: string }",
      "testStrategy": "Unit tests for schema validation with valid/invalid inputs",
      "subtasks": [
        {
          "id": "2.1",
          "title": "Research and design for define zod schemas for image fetch request/response",
          "description": "Implementation step 1 for: Define Zod schemas for image fetch request/response",
          "status": "done",
          "priority": "high",
          "dependencies": [],
          "subtasks": [],
          "userStoryId": "US001",
          "createdAt": "2025-12-10T15:58:05.862Z",
          "updatedAt": "2025-12-10T16:42:33.813Z",
          "completedAt": "2025-12-10T16:42:33.813Z"
        },
        {
          "id": "2.2",
          "title": "Set up foundation for define zod schemas for image fetch request/response",
          "description": "Implementation step 2 for: Define Zod schemas for image fetch request/response",
          "status": "done",
          "priority": "high",
          "dependencies": ["2.1"],
          "subtasks": [],
          "userStoryId": "US001",
          "createdAt": "2025-12-10T15:58:05.862Z",
          "updatedAt": "2025-12-10T16:42:33.813Z",
          "completedAt": "2025-12-10T16:42:33.813Z"
        },
        {
          "id": "2.3",
          "title": "Implement core logic for define zod schemas for image fetch request/response",
          "description": "Implementation step 3 for: Define Zod schemas for image fetch request/response",
          "status": "done",
          "priority": "high",
          "dependencies": ["2.2"],
          "subtasks": [],
          "userStoryId": "US001",
          "createdAt": "2025-12-10T15:58:05.862Z",
          "updatedAt": "2025-12-10T16:42:33.813Z",
          "completedAt": "2025-12-10T16:42:33.813Z"
        }
      ],
      "userStoryId": "US001",
      "createdAt": "2025-12-10T15:55:44.003Z",
      "updatedAt": "2025-12-10T16:42:33.813Z",
      "complexity": 5,
      "recommendedSubtasks": 3,
      "completedAt": "2025-12-10T16:42:33.813Z"
    },
    {
      "id": "3",
      "title": "Implement image format validation",
      "description": "Create validation logic for allowed image formats based on URL extension and content-type",
      "status": "done",
      "priority": "high",
      "dependencies": ["1"],
      "details": "Key insight: Many CDNs (like Adobe Scene7/Macy's) use arbitrary URL extensions but serve actual images in standard formats based on content negotiation. Example: .tif URL returns image/jpeg.\n\nApproach: Do NOT block based on URL extension. Only validate response content-type.\n\nConfig: ALLOWED_CONTENT_TYPES = ['image/jpeg', 'image/png', 'image/webp']. BLOCKED_CONTENT_TYPES = ['image/gif', 'image/svg+xml', 'image/bmp', 'image/x-icon'].\n\nPre-fetch: Only validate URL is well-formed (can be parsed).\nPost-fetch: Validate content-type header against allowed list.\n\nExport isAllowedContentType(contentType: string) function. Log URL extension vs actual content-type for analytics on CDN behavior.",
      "testStrategy": "Unit tests for extension extraction, validation of allowed/blocked formats, content-type matching",
      "subtasks": [],
      "userStoryId": "US004",
      "createdAt": "2025-12-10T15:55:44.373Z",
      "updatedAt": "2025-12-10T16:42:34.196Z",
      "complexity": 4,
      "recommendedSubtasks": 3,
      "completedAt": "2025-12-10T16:42:34.196Z"
    },
    {
      "id": "4",
      "title": "Implement image fetcher core logic",
      "description": "Create the main fetchImage() function that fetches images with appropriate headers and handles responses",
      "status": "done",
      "priority": "high",
      "dependencies": ["2", "3"],
      "details": "Use native fetch or undici. Set headers: User-Agent (Chrome 120+), Referer (productUrl), Accept (image/webp,image/png,image/jpeg). Configure timeout (default 10s). Stream response to avoid memory buffering. Return response with headers, status, and readable stream.",
      "testStrategy": "Integration tests with mock HTTP server, unit tests for header construction",
      "subtasks": [
        {
          "id": "4.1",
          "title": "Research and design for implement image fetcher core logic",
          "description": "Implementation step 1 for: Implement image fetcher core logic",
          "status": "done",
          "priority": "high",
          "dependencies": [],
          "subtasks": [],
          "userStoryId": "US007",
          "createdAt": "2025-12-10T15:58:05.903Z",
          "updatedAt": "2025-12-10T16:42:34.689Z",
          "completedAt": "2025-12-10T16:42:34.689Z"
        },
        {
          "id": "4.2",
          "title": "Set up foundation for implement image fetcher core logic",
          "description": "Implementation step 2 for: Implement image fetcher core logic",
          "status": "done",
          "priority": "high",
          "dependencies": ["4.1"],
          "subtasks": [],
          "userStoryId": "US007",
          "createdAt": "2025-12-10T15:58:05.903Z",
          "updatedAt": "2025-12-10T16:42:34.689Z",
          "completedAt": "2025-12-10T16:42:34.689Z"
        },
        {
          "id": "4.3",
          "title": "Implement core logic for implement image fetcher core logic",
          "description": "Implementation step 3 for: Implement image fetcher core logic",
          "status": "done",
          "priority": "high",
          "dependencies": ["4.2"],
          "subtasks": [],
          "userStoryId": "US007",
          "createdAt": "2025-12-10T15:58:05.903Z",
          "updatedAt": "2025-12-10T16:42:34.689Z",
          "completedAt": "2025-12-10T16:42:34.689Z"
        }
      ],
      "userStoryId": "US007",
      "createdAt": "2025-12-10T15:56:15.531Z",
      "updatedAt": "2025-12-10T16:42:34.689Z",
      "complexity": 5,
      "recommendedSubtasks": 3,
      "completedAt": "2025-12-10T16:42:34.689Z"
    },
    {
      "id": "5",
      "title": "Implement error categorization logic",
      "description": "Create error classification system to distinguish permanent vs retriable failures",
      "status": "done",
      "priority": "high",
      "dependencies": ["2"],
      "details": "Permanent failures (isPermanent: true): 400, 401, 403, 404, 410, invalid content-type, blocked extension. Retriable failures (isPermanent: false): 429 (parse Retry-After header), 500, 502, 503, 504, network timeout, ECONNRESET. Create categorizeError(statusCode, error) function. Include domain extraction from URL for logging.",
      "testStrategy": "Unit tests for each status code category, Retry-After header parsing",
      "subtasks": [],
      "userStoryId": "US002",
      "createdAt": "2025-12-10T15:56:15.908Z",
      "updatedAt": "2025-12-10T16:42:35.112Z",
      "complexity": 4,
      "recommendedSubtasks": 3,
      "completedAt": "2025-12-10T16:42:35.112Z"
    },
    {
      "id": "6",
      "title": "Implement image size validation",
      "description": "Create validation for response content-length and actual downloaded size",
      "status": "done",
      "priority": "medium",
      "dependencies": [],
      "details": "Config: MIN_IMAGE_SIZE = 1024 (1KB, reject placeholder pixels), MAX_IMAGE_SIZE = 10485760 (10MB). Check Content-Length header before download if available. Abort download if stream exceeds MAX_IMAGE_SIZE. Return permanent failure for size violations with actual size in error.",
      "testStrategy": "Unit tests for size boundary conditions, integration test with oversized mock response",
      "subtasks": [],
      "userStoryId": "US005",
      "createdAt": "2025-12-10T15:56:16.302Z",
      "updatedAt": "2025-12-10T16:42:35.495Z",
      "complexity": 2,
      "recommendedSubtasks": 2,
      "completedAt": "2025-12-10T16:42:35.495Z"
    },
    {
      "id": "7",
      "title": "Implement storage path generation",
      "description": "Create deterministic storage path generation based on storeId and image URL hash",
      "status": "done",
      "priority": "medium",
      "dependencies": [],
      "details": "Path format: {storeId}/{hash}.{ext}. Hash: SHA-256 of imageUrl, truncated to 16 chars. Extension: derived from validated content-type (jpeg->jpg, png->png, webp->webp). Export generateStoragePath(storeId, imageUrl, contentType) function. Ensure same input always produces same output.",
      "testStrategy": "Unit tests for hash consistency, extension mapping, path format validation",
      "subtasks": [],
      "userStoryId": "US006",
      "createdAt": "2025-12-10T15:56:32.897Z",
      "updatedAt": "2025-12-10T16:42:35.883Z",
      "complexity": 2,
      "recommendedSubtasks": 2,
      "completedAt": "2025-12-10T16:42:35.883Z"
    },
    {
      "id": "8",
      "title": "Implement local file storage backend",
      "description": "Create storage backend for writing images to local filesystem (phase 1)",
      "status": "done",
      "priority": "medium",
      "dependencies": [],
      "details": "Interface: StorageBackend { write(path: string, stream: ReadableStream): Promise<StorageResult> }. LocalStorageBackend: writes to configurable base directory (default: ./fetched-images for dev, /tmp for Lambda). Create directories recursively. Return { storagePath, sizeBytes }. Add to .gitignore.",
      "testStrategy": "Integration tests for file writing, directory creation, cleanup",
      "subtasks": [],
      "userStoryId": "US008",
      "createdAt": "2025-12-10T15:56:34.656Z",
      "updatedAt": "2025-12-10T16:42:36.269Z",
      "complexity": 2,
      "recommendedSubtasks": 2,
      "completedAt": "2025-12-10T16:42:36.269Z"
    },
    {
      "id": "9",
      "title": "Implement structured logging for observability",
      "description": "Add structured JSON logging for all fetch attempts with per-merchant metrics",
      "status": "done",
      "priority": "high",
      "dependencies": ["1"],
      "details": "Use @rr/shared logger (pino). Log fields: storeId, domain (extracted from imageUrl), statusCode, durationMs, sizeBytes, errorCategory, isPermanent. Log levels: info for success, warn for retriable failures, error for permanent failures. Namespace: product-image-fetcher.",
      "testStrategy": "Verify log output format, ensure all required fields present",
      "subtasks": [],
      "userStoryId": "US003",
      "createdAt": "2025-12-10T15:56:36.176Z",
      "updatedAt": "2025-12-10T16:42:36.653Z",
      "complexity": 4,
      "recommendedSubtasks": 3,
      "completedAt": "2025-12-10T16:42:36.653Z"
    },
    {
      "id": "10",
      "title": "Create main fetchAndStoreImage orchestrator",
      "description": "Create the main exported function that orchestrates validation, fetching, and storage",
      "status": "done",
      "priority": "high",
      "dependencies": ["4", "5", "6", "7", "8", "9"],
      "details": "Export fetchAndStoreImage(request: ImageFetchRequest, options?: FetchOptions): Promise<ImageFetchResponse>. Flow: 1) Validate imageUrl extension, 2) Fetch with headers, 3) Validate content-type and size, 4) Generate storage path, 5) Write to storage, 6) Return result. Handle errors at each stage with appropriate categorization.",
      "testStrategy": "Integration tests for full flow, unit tests for each stage in isolation",
      "subtasks": [
        {
          "id": "10.1",
          "title": "Research and design for create main fetchandstoreimage orchestrator",
          "description": "Implementation step 1 for: Create main fetchAndStoreImage orchestrator",
          "status": "done",
          "priority": "high",
          "dependencies": [],
          "subtasks": [],
          "userStoryId": "US001",
          "createdAt": "2025-12-10T15:58:05.953Z",
          "updatedAt": "2025-12-10T16:42:37.039Z",
          "completedAt": "2025-12-10T16:42:37.039Z"
        },
        {
          "id": "10.2",
          "title": "Set up foundation for create main fetchandstoreimage orchestrator",
          "description": "Implementation step 2 for: Create main fetchAndStoreImage orchestrator",
          "status": "done",
          "priority": "high",
          "dependencies": ["10.1"],
          "subtasks": [],
          "userStoryId": "US001",
          "createdAt": "2025-12-10T15:58:05.953Z",
          "updatedAt": "2025-12-10T16:42:37.039Z",
          "completedAt": "2025-12-10T16:42:37.039Z"
        },
        {
          "id": "10.3",
          "title": "Implement core logic for create main fetchandstoreimage orchestrator",
          "description": "Implementation step 3 for: Create main fetchAndStoreImage orchestrator",
          "status": "done",
          "priority": "high",
          "dependencies": ["10.2"],
          "subtasks": [],
          "userStoryId": "US001",
          "createdAt": "2025-12-10T15:58:05.953Z",
          "updatedAt": "2025-12-10T16:42:37.039Z",
          "completedAt": "2025-12-10T16:42:37.039Z"
        },
        {
          "id": "10.4",
          "title": "Add error handling for create main fetchandstoreimage orchestrator",
          "description": "Implementation step 4 for: Create main fetchAndStoreImage orchestrator",
          "status": "done",
          "priority": "high",
          "dependencies": ["10.3"],
          "subtasks": [],
          "userStoryId": "US001",
          "createdAt": "2025-12-10T15:58:05.953Z",
          "updatedAt": "2025-12-10T16:42:37.039Z",
          "completedAt": "2025-12-10T16:42:37.039Z"
        }
      ],
      "userStoryId": "US001",
      "createdAt": "2025-12-10T15:56:54.493Z",
      "updatedAt": "2025-12-10T16:42:37.039Z",
      "complexity": 6,
      "recommendedSubtasks": 4,
      "completedAt": "2025-12-10T16:42:37.039Z"
    },
    {
      "id": "11",
      "title": "Create product-service fetch-images handler",
      "description": "Add new Lambda handler in product-service for the /images/fetch endpoint",
      "status": "done",
      "priority": "high",
      "dependencies": ["10"],
      "details": "Create src/functions/fetch-images/ with handler.ts, contracts.ts, index.ts. Use Middy middleware chain (jsonBodyParser, zodValidator, httpErrorHandler). Accept single request initially, batch support in separate task. Wire up to serverless.yml with appropriate timeout (30s).",
      "testStrategy": "Handler unit tests with mocked fetcher, integration tests with serverless-offline",
      "subtasks": [],
      "userStoryId": "US001",
      "createdAt": "2025-12-10T15:56:54.861Z",
      "updatedAt": "2025-12-10T16:46:41.376Z",
      "complexity": 4,
      "recommendedSubtasks": 3,
      "completedAt": "2025-12-10T16:46:41.376Z"
    },
    {
      "id": "12",
      "title": "Create OpenAPI contracts for fetch-images endpoint",
      "description": "Define Zod schemas with OpenAPI extensions for request/response documentation",
      "status": "done",
      "priority": "high",
      "dependencies": ["11"],
      "details": "Follow pattern from normalize-product-views/contracts.ts. Include request schema, success response schema, failure response schema, error response schema. Add realistic examples for Redoc documentation. Register in OpenAPI generator script.",
      "testStrategy": "OpenAPI spec generates without errors, Redoc displays correctly",
      "subtasks": [],
      "userStoryId": "US001",
      "createdAt": "2025-12-10T15:56:55.248Z",
      "updatedAt": "2025-12-10T16:46:41.430Z",
      "complexity": 4,
      "recommendedSubtasks": 3,
      "completedAt": "2025-12-10T16:46:41.430Z"
    },
    {
      "id": "13",
      "title": "Add batch processing support to handler",
      "description": "Extend the fetch-images handler to accept and process multiple image requests in a single API call",
      "status": "done",
      "priority": "medium",
      "dependencies": ["11"],
      "details": "Accept array of ImageFetchRequest (max 100). Process concurrently with configurable concurrency limit (default 10). Return array of results in same order as input. Include summary: { total, successful, failed }. Individual failures don't fail entire batch.",
      "testStrategy": "Test batch processing, ordering preservation, partial failure handling, concurrency limits",
      "subtasks": [],
      "userStoryId": "US009",
      "createdAt": "2025-12-10T15:57:11.361Z",
      "updatedAt": "2025-12-10T16:47:21.375Z",
      "complexity": 3,
      "recommendedSubtasks": 2,
      "completedAt": "2025-12-10T16:47:21.375Z"
    },
    {
      "id": "14",
      "title": "Add configuration management",
      "description": "Create centralized configuration with environment variable overrides for all tunable parameters",
      "status": "done",
      "priority": "medium",
      "dependencies": ["1"],
      "details": "Config options: FETCH_TIMEOUT_MS (10000), MAX_IMAGE_SIZE_BYTES (10485760), MIN_IMAGE_SIZE_BYTES (1024), STORAGE_BASE_PATH (./fetched-images or /tmp), ALLOWED_CONTENT_TYPES, BATCH_CONCURRENCY (10), USER_AGENT. Use @rr/shared config pattern if exists, otherwise create config.ts with env var parsing.",
      "testStrategy": "Test default values, environment variable overrides, validation of numeric configs",
      "subtasks": [],
      "userStoryId": "US004",
      "createdAt": "2025-12-10T15:57:11.730Z",
      "updatedAt": "2025-12-10T16:47:21.417Z",
      "complexity": 3,
      "recommendedSubtasks": 2,
      "completedAt": "2025-12-10T16:47:21.417Z"
    },
    {
      "id": "15",
      "title": "Write comprehensive test suite",
      "description": "Create thorough test coverage for the package including unit, integration, and edge case tests",
      "status": "done",
      "priority": "high",
      "dependencies": ["10"],
      "details": "Unit tests: validation functions, error categorization, path generation, config. Integration tests: mock HTTP server for various response scenarios (success, 403, 429, timeout, invalid content-type). Edge cases: very large images, slow responses, redirect chains, malformed URLs. Target >90% coverage.",
      "testStrategy": "Coverage report shows >90%, all edge cases documented and tested",
      "subtasks": [],
      "userStoryId": "US001",
      "createdAt": "2025-12-10T15:57:12.130Z",
      "updatedAt": "2025-12-10T16:47:21.474Z",
      "complexity": 4,
      "recommendedSubtasks": 3,
      "completedAt": "2025-12-10T16:47:21.474Z"
    }
  ],
  "metadata": {
    "version": "1.0",
    "created": "2025-12-10T15:55:43.643Z",
    "lastUpdated": "2025-12-10T16:47:21.474Z",
    "totalTasks": 25,
    "completedTasks": 25,
    "blockedTasks": 0
  }
}
